<!DOCTYPE html>
<html lang="pt-br">

<head>

   <meta name="format-detection" content="telephone=no">
   <meta name="msapplication-tap-highlight" content="no">
   <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">

   <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />
   <meta charset="UTF-8">

   <title>Bolinhos APP</title>
   <style>
      @font-face {
         font-family: 'Material Icons';
         font-style: normal;
         font-weight: 400;
         src: url(iconfont/MaterialIcons-Regular.eot); /* For IE6-8 */
         src: local('Material Icons'),
            local('MaterialIcons-Regular'),
            url(iconfont/MaterialIcons-Regular.woff2) format('woff2'),
            url(iconfont/MaterialIcons-Regular.woff) format('woff'),
            url(iconfont/MaterialIcons-Regular.ttf) format('truetype');
      }

      .material-icons {
         font-family: 'Material Icons';
         font-weight: normal;
         font-style: normal;
         font-size: 24px;  /* Preferred icon size */
         display: inline-block;
         line-height: 1;
         text-transform: none;
         letter-spacing: normal;
         word-wrap: normal;
         white-space: nowrap;
         direction: ltr;

         /* Support for all WebKit browsers. */
         -webkit-font-smoothing: antialiased;
         /* Support for Safari and Chrome. */
         text-rendering: optimizeLegibility;

         /* Support for Firefox. */
         -moz-osx-font-smoothing: grayscale;

         /* Support for IE. */
         font-feature-settings: 'liga';
      }

      .title{
         font-size: 14px;
      }

   
      .tabs{
         background-color: #f58220;
      }

      .tabs .tab a{
         color:#231f20;
      } /*Black color to the text*/

    /* .tabs .tab a:hover {
         background-color:#eee;
         color:#000;
      } /*Text color on hover*/

      .tabs .tab a.active {
         color:#fff;
      } /*Background and text color when a tab is active*/

      .tabs .indicator {
         background-color:#fff;
      } /*Color of underline*/

      blockquote{
         background-color: #a79d9d2e;
         border-left: 5px solid #f58220;
         margin-right: 1.5rem;
         font-size: 16px;
         margin-bottom: 2px;
      }
      .collection{
         box-shadow: 2px 2px #ccc;
         border-radius: 5px;
      }

      .input-field label {
         color: #000;
      }
      /* label focus color */
      .input-field input[type=text]:focus + label {
         color: #000;
      }
      /* label underline focus color */
      .input-field input[type=text]:focus {
         border-bottom: 1px solid #000;
         box-shadow: 0 1px 0 0 #000;
      }
      /* valid color */
      .input-field input[type=text].valid {
         border-bottom: 1px solid #000;
         box-shadow: 0 1px 0 0 #000;
      }
      /* invalid color */
      .input-field input[type=text].invalid {
         border-bottom: 1px solid #000;
         box-shadow: 0 1px 0 0 #000;
      }
      /* icon prefix focus color */
      .input-field .prefix.active {
         color: #000;
      }
      .input-field input:focus + label {
         color: orange !important;
      }
      /* label underline focus color */
      .row .input-field input:focus {
         border-bottom: 1px solid orange !important;
         box-shadow: 0 1px 0 0 orange !important
      }
      .ui-autocomplete { position: absolute; cursor: default;z-i:3000 !important;} 
      .ui-menu .ui-menu-item-wrapper {
         padding: 15px 1em 15px .4em;
      }
      .modal.modal-fixed-footer .modal-content {
         height: calc(100% - 20px);
      }
      .modal{
         max-height: 85%;
         height: 85%;
         width: 90%;
      }
      .modal.modal-fixed-footer {
         padding: 0;
         height: 85%;
      }

      blockquote{
         margin-right: 3.5rem;
      }

      .collection .collection-item.avatar {

         padding-left: 25px;
      }

      .datepicker-date-display {
         background-color: #f58220 !important;
      }
      .datepicker-table td.is-selected {
         background-color: #f58220 !important;
      }

      .is-today{
         background-color: #f3ecec;
      }

      .datepicker-modal {
         height: 75%;
      }
   </style>
</head>

<body>

   <!-- Modal Cadastro -->
   <div id="modal1" class="modal modal-fixed-footer">
      <div class="modal-content">
         <input id="editar" style="display:none">
         <input id="id_cliente" style="display:none">
         <div id="nome"></div>
         <div class="input-field col s12">
            <select id="opcao">
               <option value="0" disabled selected>Opção:</option>
               <option value="1">Cobrança</option>
               <option value="2">Visita</option>
               <option value="3">Outra</option>
               <option value="4">Pago</option>
            </select>
         </div>
         <input type="text" id="data_agenda" autocomplete="off" class="datepicker">
         <div class="input-field col s12">
            <textarea id="textarea1" placeholder="Observação" class="materialize-textarea" style="height: 68px !important"></textarea>

            <div class="section scrollspy">
               <div class="chip"> R$ 35,00 </div>
               <div class="chip"> R$ 45,00 </div>
               <div class="chip"> R$ 70,00 </div>
               <div class="chip"> R$ 90,00 </div>
               <div class="chip"> R$ 105,00 </div>
               <div class="chip"> R$ 135,00 </div>
            </div>

         </div>
      </div>
      <div class="modal-footer">
         <button class="btn grey lighten-1 waves-effect waves-light" onclick="cancelar()" name="action">Cancelar</button>
         <button class="btn orange darken-4 waves-effect waves-light" onclick="cadastro()" name="action">Enviar</button>
      </div>

   </div>

   <!-- Modal Gastos -->
   <div id="modal_gastos" class="modal modal-fixed-footer">
      <div class="modal-content">
         <h4>Gastos</h4>
         <div class="row">
            <div class="input-field col s8">
               <input placeholder="Descrição" id="descricao" type="text" class="validate">

            </div>
            <div class="input-field col s4">
               <input placeholder="Valor" id="valor" type="text" data-thousands="." data-decimal=",">
               <label for="valor">R$</label>
            </div>
         </div>
      </div>
      <div class="modal-footer">
         <a href="#!" onclick="fecharGastos()" class="waves-effect waves-green btn-flat">Cancelar</a>
         <a href="#!" class="waves-effect waves-green btn-flat orange white-text" onclick="gastos()">Inserir</a>
      </div>
   </div>




   <div class="navbar-fixed">
      <nav>
         <div class="nav-wrapper" style="background-color:#231f20">
            <img src="img/bolinhos_logo.PNG" style="width: 50px; margin-top: 4px; float: left;" />
            <a href="#!" class="brand-logo left" style="margin-left: 10px; position: initial; margin-left: 10px">Bolinhos</a>
         </div>
         <ul id="tabs-swipe-demo" class="tabs">
            <li class="tab col s3"><a href="#test-swipe-1" onclick="preencheAgenda()">Hoje</a></li>
            <li class="tab col s3"><a href="#test-swipe-2" class="todos" ontouchstart="preencheTodos(6)">Todos</a></li>
            <li class="tab col s3"><a href="#test-swipe-3" onclick="preencheGastos()">Gastos</a></li>
         </ul>
      </nav>
   </div>



   <div id="test-swipe-1" class="col s12" style="margin-top: 55px">

      <!-- HOJE -->


      <div class="container" style="margin-top: 55px">

         <nav style="margin-top: 10px; border-radius: 10px; background-color: #414144">
            <div class="nav-wrapper">
               <form>
                  <div class="input-field">
                     <input id="search" placeholder="Pesquisar..." type="search" required onkeyup="pesquisa()">
                     <label class="label-icon" for="search"><i class="material-icons">search</i></label>
                     <i class="material-icons" onclick="limpaPesquisa()">close</i>
                  </div>
               </form>
            </div>
         </nav>
         <div id="agenda" class="center">
            <div class="preloader-wrapper big active">
               <div class="spinner-layer spinner-blue-only">
                  <div class="circle-clipper left">
                     <div class="circle"></div>
                  </div>
                  <div class="gap-patch">
                     <div class="circle"></div>
                  </div>
                  <div class="circle-clipper right">
                     <div class="circle"></div>
                  </div>
               </div>
            </div>
         </div>

      </div>

      <a href="#" onclick="pegarContato()" class="btn-floating btn-large waves-effect waves-light black" style="position: fixed ; right: 10px;bottom: 60px;">
         <i class="material-icons">add</i>
      </a>



   </div>


   </div>
   <!-- TODOS -->
   <div id="test-swipe-2" class="col s12 " style="margin-top: 55px">


      <div class="container">
         <nav style="margin-top: 10px; border-radius: 10px; background-color: #414144">
            <div class="nav-wrapper">
               <form>
                  <div class="input-field">
                     <input id="searchTodos" placeholder="Pesquisar..." type="search" required onkeyup="">
                     <label class="
                        label-icon" for="searchTodos"><i class="material-icons">search</i></label>
                     <i class="material-icons" onclick="limpaPesquisa()">close</i>
                  </div>
               </form>
            </div>
         </nav>
         <div class="row">

            <div class="input-field col s5">
               <span>de</span>
               <input type="text" id="data1" autocomplete="off" class="datepicker">
            </div>
            <div class="input-field col s5">
               <span>até</span>
               <input type="text" id="data2" autocomplete="off" class="datepicker">
            </div>
            <div class="input-field col s2"><a class="waves-effect waves-light btn grey darken-2" style="margin-top: 15px;"
                  onclick="pesquisaData()">Ok</a></div>
         </div>


         <div id="todos" class="center">

            <div class="preloader-wrapper big active">
               <div class="spinner-layer spinner-blue-only">
                  <div class="circle-clipper left">
                     <div class="circle"></div>
                  </div>
                  <div class="gap-patch">
                     <div class="circle"></div>
                  </div>
                  <div class="circle-clipper right">
                     <div class="circle"></div>
                  </div>
               </div>
            </div>


         </div>
      </div>
   </div>


   <div id="test-swipe-3" class="col s12 " style="margin-top: 55px">

      <div class="container">
         <nav style="margin-top: 10px; border-radius: 10px; background-color: #f58220">
            <div class="nav-wrapper">
               <form>
                  <div class="input-field">
                     <input id="searchGastos" placeholder="Pesquisar..." type="search" required>
                     <label class="label-icon" for="searchGastos"><i class="material-icons">search</i></label>
                     <i class="material-icons" onclick="limpaPesquisa()">close</i>
                  </div>
               </form>
            </div>
         </nav>
         <div class="row">

            <div class="input-field col s5">
               <span>de</span>
               <input type="text" id="data3" autocomplete="off" class="datepicker">
            </div>
            <div class="input-field col s5">
               <span>até</span>
               <input type="text" id="data4" autocomplete="off" class="datepicker">
            </div>
            <div class="input-field col s2"><a class="waves-effect waves-light btn grey darken-2" style="margin-top: 15px"
                  onclick="pesquisaGastosComData()">Ok</a></div>
         </div>
         <h5 class="right-align">Total R$ <span id="total"> </span></h5>

         <div id="gastos" class="center">

            <div class="preloader-wrapper big active">
               <div class="spinner-layer spinner-blue-only">
                  <div class="circle-clipper left">
                     <div class="circle"></div>
                  </div>
                  <div class="gap-patch">
                     <div class="circle"></div>
                  </div>
                  <div class="circle-clipper right">
                     <div class="circle"></div>
                  </div>
               </div>
            </div>

         </div>
         <a href="#" onclick="abrirGastos()" class="btn-floating btn-large waves-effect waves-light" style="position: fixed ; right: 10px;bottom: 60px; background-color:#f58220">
            <i class="material-icons">add</i>
         </a>
      </div>


   </div>


   <script type="text/javascript" src="cordova.js"></script>
   <script type="text/javascript" src="js/index.js"></script>
   <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
   <script type="text/javascript" src="js/materialize.min.js"></script>
   <script src="js/jquery.maskMoney.js"></script>



   <script>

      $("#valor").maskMoney();

      var db;
      function devicereadyFun() {
         db = window.sqlitePlugin.openDatabase({
            name: 'boinhos.db',
            location: 'default'
         });

         db.transaction(function (tx) {


            // tx.executeSql('DROP TABLE agenda');
            //tx.executeSql('DROP TABLE gastos');
            tx.executeSql('CREATE TABLE IF NOT EXISTS Agenda ( codigo INTEGER PRIMARY KEY AUTOINCREMENT, data_criado datetime default current_timestamp, data_agenda datetime, opcao INTEGER, observacao TEXT, cli_codigo INTEGER, cli_nome TEXT  )');
            tx.executeSql('CREATE TABLE IF NOT EXISTS Gastos (codigo INTEGER PRIMARY KEY AUTOINCREMENT, data_criado datetime default current_timestamp, descricao TEXT, valor DOUBLE)');

            // tx.executeSql("SELECT * FROM Gastos WHERE data_criado BETWEEN '2018-12-29 00:00:00' AND '2018-12-31 23:59:59'", [], function (tx, res) {
            //    alert("Quantidade Resultados: " + res.rows.length);
            //    for (var i = 0; i < res.rows.length; i++) {
            //       alert("Linha " + i + ": " + res.rows.item(i).data_criado);
            //    }
            // });

            // tx.executeSql("SELECT * FROM agenda", [], function (tx, res) {
            //    alert("Quantidade Resultados: " + res.rows.length);
            //    for (var i = 0; i < res.rows.length; i++) {
            //       alert("Linha " + i + ": " + res.rows.item(i).data_criado);
            //    }
            // });

         });
         pegarTodosContatos();



      }
      function dbcopy() {
         //Database filename to be copied is demo.db

         //location = 0, will copy the db to default SQLite Database Directory, /Library/LocalDatabase (Disable iCloud Backup)
         //window.plugins.sqlDB.copy("demo.db", 0, copysuccess, copyerror);



         //location = 1, will copy the database to /Library folder
         // window.plugins.sqlDB.copy("demo.db", 1, copysuccess, copyerror);



         //location = 2, will copy the database to /Documents folder 
         window.plugins.sqlDB.copyDbToStorage("boinhos.db", 0, '/sdcard/mydb/', true, copysuccess, copyerror);
         //window.plugins.sqlDB.copyDbToStorage(dbname, location, destination, overwrite, success, error);

      }
      function removeDB() {
         var location = 1;
         window.plugins.sqlDB.remove("boinhos.db", location, rmsuccess, rmerror);
      }

      function copysuccess() {
         //open db and run your queries
         //db = window.sqlitePlugin.openDatabase({ name: "boinhos.db" });
         console.log('sucess copy');
         devicereadyFun()

      }

      function copyerror(e) {
         //db already exists or problem in copying the db file. Check the Log.
         console.log("Error Code = " + JSON.stringify(e));
         //e.code = 516 => if db exists
         console.log('error copy')
         devicereadyFun()
      }

      document.addEventListener('deviceready', dbcopy, false);

      var el = $('.tabs');
      var options = {}
      var instance = M.Tabs.init(el, options);
      var sele = M.Tabs.getInstance(el);
      sele.select('test-swipe-1');


      function resizeTab() {
         var maxHeight = document.body.scrollHeight - 50;

         $(".tabs-content").css('height', maxHeight + 'px');
      }

      $('.modal').modal();
      $('select').formSelect();

      document.addEventListener('DOMContentLoaded', function () {

         var options2 = {
            autoClose: true,
            vibrate: true,
            format: 'dd/mm/yyyy',
            i18n: {
               months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"],
               monthsShort: ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"],
               weekdays: ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"],
               weekdaysShort: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sab"],
               weekdaysAbbrev: ["D", "S", "T", "Q", "Q", "S", "S"]
            },
         }
         var elems = document.querySelectorAll('.datepicker');
         var instances = M.Datepicker.init(elems, options2);
      });





      var date = new Date();
      var hoje = ("0" + date.getDate()).slice(-2) + '/' + ("0" + (date.getMonth() + 1)).slice(-2) + '/' + date.getFullYear();

      $(".datepicker").attr("placeholder", "Selecione a data");

      function pegarContato() {
         navigator.contacts.pickContact(function (contact) {
            console.log('The following contact has been selected:' + JSON.stringify(contact));
            //Build a simple string to display the Contact - would be better in Handlebars
            var s = "";
            var nome = getName(contact);


            s += "<h4 class='cli_nome'>" + nome + "</h4>";

            if (contact.phoneNumbers) {
               s += ' Telefone: ' + contact.phoneNumbers[0].value + "<br/>";
            }


            console.log(contact.id);
            $("#id_cliente").val(contact.id);
            $('#modal1').modal('open');
            $("#nome").html(s);



         }, function (err) {
            console.log('Error: ' + err);
         });
      }

      $(document).ready(function () {
         $('.modal').modal({
            dismissible: false // Modal can be dismissed by clicking outside of the modal

         });
      });

      function getName(c) {
         var name = c.displayName;
         if (!name || name === "") {
            if (c.name.formatted) return c.name.formatted;
            if (c.name.givenName && c.name.familyName) return c.name.givenName + " " + c.name.familyName;
            return "";
         }
         return name;
      }


      function cadastro() {

         var editar = $("#editar").val();

         var cli_codigo = $("#id_cliente").val();
         console.log(cli_codigo);
         var data_agenda = $("#data_agenda").val();
         var opcao = $("#opcao").val();
         var observacao = $("#textarea1").val();
         var cliente_nome = $("#nome").text();

         if (!data_agenda) {
            alert("Selecione uma data!");
            return;
         }

         data_agenda = data_agenda.split("/").reverse().join("/");


         if (!editar) {
            db.transaction(function (tx) {
               tx.executeSql('INSERT INTO Agenda (data_agenda, opcao, observacao, cli_codigo, cli_nome) values ("' + data_agenda + '", ' + opcao + ', "' + observacao + '", "' + cli_codigo + '", "' + cliente_nome + '"); ', [], function (tx, rs) {


               }, function (tx, error) {
                  console.log('SELECT error: ' + error.message);
               });
            });
         } else {
            db.transaction(function (tx) {
               tx.executeSql('UPDATE Agenda SET data_agenda="' + data_agenda + '" , opcao=' + opcao + ' , observacao="' + observacao + '" , cli_codigo="' + cli_codigo + '" , cli_nome="' + cliente_nome + '" WHERE codigo=' + editar + ' ', [], function (tx, rs) {


               }, function (tx, error) {
                  console.log('SELECT error: ' + error.message);
               });
            });
         }

         fecharCadastro();
         preencheAgenda();
         preencheTodos(6);


      }

      function fecharCadastro() {
         $('#modal1').modal('close');
         limpaCampos();
      }

      var contatos;



      function preencheAgenda() {
         var date = new Date();
         var hoje = date.getFullYear() + '/' + ("0" + (date.getMonth() + 1)).slice(-2) + '/' + ("0" + date.getDate()).slice(-2);

         var agenda = '';

         var options = new ContactFindOptions();


         db.transaction(function (transaction) {
            transaction.executeSql('SELECT *  FROM Agenda   WHERE data_agenda="' + hoje + '" ORDER BY data_criado desc', [],
               //transaction.executeSql('SELECT *  FROM Agenda ', [],
               function (transaction, rs) {
                  for (var i = 0; i < rs.rows.length; i++) {

                     var telefone;
                     var cli_codigo = rs.rows.item(i).cli_codigo;
                     var cliente = $.grep(contatos, function (e) { return e.id == cli_codigo; });


                     if (!cliente[0].displayName) {
                        continue
                     }

                     if (!cliente[0].phoneNumbers) {
                        telefone = "-";
                     } else {
                        telefone = cliente[0].phoneNumbers[0].value
                     }


                     switch (rs.rows.item(i).opcao) {
                        case 1:
                           opcao = 'Cobrança';
                           cor = 'red';
                           break;
                        case 2:
                           opcao = 'Visita';
                           cor = 'blue';
                           break;
                        case 3:
                           opcao = 'Outra';
                           cor = 'orange';
                           break;
                        case 4:
                           opcao = 'Pago';
                           cor = 'green';
                           break;
                        default:
                           opcao = '-';
                           cor = 'grey lighten-3';
                     }
                     if (rs.rows.item(i).opcao == 4) {
                        agenda += '<ul class="collection collection-agenda"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + ' </span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i></a></li></ul>';
                     } else {
                        agenda += '<ul class="collection collection-agenda"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + '</span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i><br><br><i class="material-icons green-text" onclick="pagar(' + rs.rows.item(i).codigo + ')">done</i></a></li></ul>'
                     }


                  }

                  $("#agenda").html(agenda);
               }, function (tx, error) {
                  console.log('Erro: ' + error.message);
               });
         });


      }

      var contador = 6;

      $(window).scroll(function () {
         if ($(window).scrollTop() + $(window).height() == $(document).height()) {
            contador = contador + 6;
            preencheTodos(contador);
         }
      });

      var data = false;

      function pesquisaData() {
         data = true;
         preencheTodos(6);
      }


      function preencheTodos(count) {
         var date = new Date();
         var hoje = date.getFullYear() + '/' + ("0" + (date.getMonth() + 1)).slice(-2) + '/' + ("0" + date.getDate()).slice(-2);

         var agenda = '';

         var data1 = $("#data1").val().split("/").reverse().join("/");
         var data2 = $("#data2").val().split("/").reverse().join("/");

         var options = new ContactFindOptions();

         if (data) {
            db.transaction(function (transaction) {
               //transaction.executeSql('SELECT *  FROM Agenda   WHERE data_agenda="' + hoje + '" ORDER BY data_criado desc', [],
               transaction.executeSql('SELECT * FROM Agenda WHERE data_agenda BETWEEN  \'' + data1 + '\' AND  \'' + data2 + '\'  ORDER BY data_agenda DESC ', [],
                  function (transaction, rs) {
                     for (var i = 0; i < count; i++) {

                        var telefone;
                        if (!rs.rows.item(i)) {
                           continue;
                        }
                        var cli_codigo = rs.rows.item(i).cli_codigo;
                        var cliente = $.grep(contatos, function (e) { return e.id == cli_codigo; });

                        if (!cliente[0].phoneNumbers) {
                           telefone = "-";
                        } else {
                           telefone = cliente[0].phoneNumbers[0].value
                        }


                        switch (rs.rows.item(i).opcao) {
                           case 1:
                              opcao = 'Cobrança';
                              cor = 'red';
                              break;
                           case 2:
                              opcao = 'Visita';
                              cor = 'blue';
                              break;
                           case 3:
                              opcao = 'Outra';
                              cor = 'orange';
                              break;
                           case 4:
                              opcao = 'Pago';
                              cor = 'green';
                              break;
                           default:
                              opcao = '-';
                              cor = 'grey lighten-3';
                        }
                        if (rs.rows.item(i).opcao == 4) {
                           agenda += '<ul class="collection colletion-todos"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + ' </span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i></a></li></ul>';
                        } else {
                           agenda += '<ul class="collection colletion-todos"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + '</span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i><br><br><i class="material-icons green-text" onclick="pagar(' + rs.rows.item(i).codigo + ')">done</i></a></li></ul>'
                        }


                     }

                     $("#todos").html(agenda);
                  }, function (tx, error) {
                     console.log('Erro: ' + error.message);
                  });
            });

         } else {
            db.transaction(function (transaction) {
               //transaction.executeSql('SELECT *  FROM Agenda   WHERE data_agenda="' + hoje + '" ORDER BY data_criado desc', [],
               transaction.executeSql('SELECT *  FROM Agenda ', [],
                  function (transaction, rs) {
                     for (var i = 0; i < count; i++) {

                        var telefone;
                        if (!rs.rows.item(i)) {
                           continue;
                        }
                        var cli_codigo = rs.rows.item(i).cli_codigo;
                        var cliente = $.grep(contatos, function (e) { return e.id == cli_codigo; });

                        if (!cliente[0].phoneNumbers) {
                           telefone = "-";
                        } else {
                           telefone = cliente[0].phoneNumbers[0].value
                        }


                        switch (rs.rows.item(i).opcao) {
                           case 1:
                              opcao = 'Cobrança';
                              cor = 'red';
                              break;
                           case 2:
                              opcao = 'Visita';
                              cor = 'blue';
                              break;
                           case 3:
                              opcao = 'Outra';
                              cor = 'orange';
                              break;
                           case 4:
                              opcao = 'Pago';
                              cor = 'green';
                              break;
                           default:
                              opcao = '-';
                              cor = 'grey lighten-3';
                        }
                        if (rs.rows.item(i).opcao == 4) {
                           agenda += '<ul class="collection colletion-todos"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + ' </span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i></a></li></ul>';
                        } else {
                           agenda += '<ul class="collection colletion-todos"><li class="collection-item avatar"> <span class="' + cor + ' white-text chip"> ' + opcao + ' </span><span style="font-size: 18px;">' + rs.rows.item(i).data_agenda.split("/").reverse().join("/") + '</span> <br><span style="font-size: 16px" class="title' + rs.rows.item(i).codigo + '"> ' + cliente[0].displayName + '</span><br>contato: <span class="telefone' + rs.rows.item(i).codigo + '">' + telefone + '</span></p><blockquote>' + rs.rows.item(i).observacao + '</blockquote><a href="#!" class="secondary-content"><i class="material-icons orange-text" onclick="editar(' + rs.rows.item(i).codigo + ')">edit</i><br><br><i class="material-icons red-text" onclick="deletar(' + rs.rows.item(i).codigo + ')">delete</i><br><br><i class="material-icons green-text" onclick="pagar(' + rs.rows.item(i).codigo + ')">done</i></a></li></ul>'
                        }


                     }

                     $("#todos").html(agenda);
                  }, function (tx, error) {
                     console.log('Erro: ' + error.message);
                  });
            });

         }

         data = false;

      }



      function pegarTodosContatos() {
         var opcao;
         var cor;
         options.filter = "";
         options.multiple = true;
         var fields = ["*"];
         navigator.contacts.find(fields, onSucess, onError, options);

      }

      function onSucess(contacts) {
         contatos = contacts;
         console.log(contacts);
         $("#agenda").removeClass();
         preencheAgenda();
         $("#todos").removeClass();
         preencheTodos(6);
         $("#gastos").removeClass();
         preencheGastos();

      }

      function onError() {
         console.log("some error");
      }

      function resetSelect(id) {
         $(id).formSelect('destroy');
         $(id).val('0').change();
         $(id).formSelect();
      }

      function limpaCampos() {
         resetSelect("#opcao");
         $('.datepicker').val('');
         //$('.datepicker').datepicker({}).datepicker("setDate", new Date());
         // $("#tel1").val('');
         // $("#tel2").val('');
         $("#textarea1").val('');
         $("#descricao").val('');
         $("#valor").val('');
         $("#editar").val('');
      }


      function editar(idAgenda) {

         console.log($(".title" + idAgenda).text());
         console.log($(".telefone" + idAgenda).text());


         var nome = "<h4>" + $(".title" + idAgenda).text() + "</h4>";

         nome += 'Telefone: ' + $(".telefone" + idAgenda).text() + "<br/>"

         $("#nome").html(nome);

         $("#editar").val(idAgenda);




         db.transaction(function (tx) {


            tx.executeSql('SELECT * FROM Agenda WHERE codigo=' + idAgenda, [], function (tx, rs) {



               $("#textarea1").val(rs.rows.item(0).observacao);
               $('#data_agenda').val(rs.rows.item(0).data_agenda.split("/").reverse().join("/"));
               $("#id_cliente").val(rs.rows.item(0).cli_codigo);
               $('#opcao').formSelect('destroy');
               $('#opcao').val(rs.rows.item(0).opcao).change();
               $('#opcao').formSelect();



            }, function (tx, error) {
               console.log('SELECT error: ' + error.message);
            });
         });

         $('#modal1').modal('open');

         preencheAgenda()
         preencheTodos(6);



      }

      function cancelar() {
         $('#modal1').modal('close');
         limpaCampos();
      }

      $(".todos").on("click", function () {
         preencheTodos(6);
      });

      $('.chip').on('click', function () {
         var dinheiro = $(this).text();
         var observacao = $("#textarea1").val();

         $("#textarea1").val(observacao + dinheiro);
         $('#textarea1').scrollTop($('#textarea1')[0].scrollHeight);
      });

      function pagar(idAgenda) {
         if (confirm("Pago?")) {
            db.transaction(function (tx) {
               tx.executeSql('UPDATE Agenda SET opcao=4 WHERE codigo=' + idAgenda + ' ;', [], function (tx, rs) {

               }, function (tx, error) {
                  console.log('SELECT error: ' + error.message);
               });
            });
            preencheAgenda();
            preencheTodos(6);
         }
      }

      function pesquisaTodos() {
         var input = document.getElementById("searchTodos");
         var filter = input.value.toLowerCase();
         var nodes = document.getElementsByClassName('collection');

         for (i = 0; i < nodes.length; i++) {
            if (nodes[i].innerText.toLowerCase().includes(filter)) {
               nodes[i].style.display = "block";
            } else {
               nodes[i].style.display = "none";
            }
         }
      }

      $('#searchTodos').keyup(function () {

         var txt = $('#searchTodos').val();
         $(".colletion-todos").each(function () {
            if ($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1) {
               $(this).show();
            } else {
               $(this).hide();
            }
         });
      })


      $('#searchTodos').keyup(function () {

         var txt = $('#searchTodos').val();
         $(".colletion").each(function () {
            if ($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1) {
               $(this).show();
            } else {
               $(this).hide();
            }
         });
      })


      $('#search').keyup(function () {

         var txt = $('#search').val();
         $(".collection-agenda").each(function () {
            if ($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1) {
               $(this).show();
            } else {
               $(this).hide();
            }
         });
      })

      $('#searchGastos').keyup(function () {

         var txt = $('#searchGastos').val();
         $(".collection-gastos").each(function () {
            if ($(this).text().toUpperCase().indexOf(txt.toUpperCase()) != -1) {
               $(this).show();
            } else {
               $(this).hide();
            }
         });
      })

      function abrirGastos() {
         $('#modal_gastos').modal('open');
         limpaCampos();
      }

      function preencheGastos() {
         var gastos = '';

         var date = new Date(), y = date.getFullYear(), m = date.getMonth();
         var firstDay = new Date(y, m, 1).toISOString().substring(0, 10);
         var lastDay = new Date(y, m + 1, 0).toISOString().substring(0, 10);

         console.log(firstDay)
         console.log(lastDay)

         db.transaction(function (tx) {

            tx.executeSql('SELECT * FROM Gastos WHERE data_criado BETWEEN \'' + firstDay + ' 00:00:00\' AND  \'' + lastDay + ' 23:59:59\' ', [], function (tx, rs) {

               for (var i = 0; i < rs.rows.length; i++) {
                  var data_gastos = rs.rows.item(i).data_criado.replace(/^(\d+)-(\d+)-(\d+)(.*):\d+$/, '$3/$2/$1$4')
                  console.log("gastos " + i + ": " + rs.rows.item(i).codigo);
                  gastos += '<ul class="collection collection-gastos" style="width:85%"><li class="collection-item"><div><span class="data_gasto">' + data_gastos + '</span > <br><b style="font-size: 15px;">' + rs.rows.item(i).descricao + '</b><a href="#!" class="secondary-content"><i class="material-icons red-text" onclick="deletarGastos(' + rs.rows.item(i).codigo + ')">delete</i></a><span class="right" style="margin-right: 10px;">R$ <span class="dinheiro">' + rs.rows.item(i).valor + '</span></span></div></li ></ul > ';
               }

               $("#gastos").html(gastos);

               total();

            }, function (tx, error) {
               console.log('SELECT error: ' + error.message);
            });
         });

         total();
      }

      function total() {
         var sum = 0;
         $('.dinheiro:visible').each(function () {
            sum += parseFloat($(this).text().replace(',', '.'));
         });

         sum = sum.toFixed(2).toString().replace('.', ',');


         $("#total").html(sum);


      }

      function gastos() {
         var descricao = $("#descricao").val();
         var valor = $("#valor").val();

         valor = valor.replace('.', '');

         valor = parseFloat(valor.replace(',', '.'));



         if (descricao && valor) {
            db.transaction(function (tx) {
               tx.executeSql('INSERT INTO Gastos (descricao, valor) values ("' + descricao + '", ' + valor + '); ', [], function (tx, rs) {


               }, function (tx, error) {
                  console.log('INSERT error: ' + error.message);
               });
            });
            fecharGastos();
            preencheGastos();
         } else {
            alert("Preencha todos os campos!");
         }
      }


      function fecharGastos() {
         $('#modal_gastos').modal('close');
         limpaCampos();
      }

      function pesquisaGastosComData() {

         $("#gastos").html('');

         var gastos = '';


         var inicio = $("#data3").val().split("/").reverse().join("/").replace(/\//g, '-');
         var fim = $("#data4").val().split("/").reverse().join("/").replace(/\//g, '-');

         db.transaction(function (tx) {


            tx.executeSql('SELECT * FROM gastos WHERE data_criado BETWEEN \'' + inicio + ' 00:00:00\' AND \'' + fim + ' 23:59:59\' ', [], function (tx, rs) {

               console.log(inicio);
               console.log(fim);
               for (var i = 0; i < rs.rows.length; i++) {



                  var data_gastos = rs.rows.item(i).data_criado.replace(/^(\d+)-(\d+)-(\d+)(.*):\d+$/, '$3/$2/$1$4')
                  console.log("gastos " + i + ": " + rs.rows.item(i).codigo);
                  gastos += '<ul class="collection collection-gastos with-header" style="width: 80%;"><li class="collection-item"><div><span class="data_gasto">' + data_gastos + '</span > <br><b style="font-size: 15px;">' + rs.rows.item(i).descricao + '</b><a href="#!" class="secondary-content"><i class="material-icons red-text" onclick="deletarGastos(' + rs.rows.item(i).codigo + ')">delete</i></a><span class="right" style="margin-right: 10px;">R$ <span class="dinheiro">' + rs.rows.item(i).valor + '</span></span></div></li ></ul > ';
               }

               $("#gastos").html(gastos);

               total();

            }, function (tx, error) {
               console.log('SELECT error: ' + error.message);
            });
         });

         total();

      }



      function deletarGastos(idGastos) {
         if (confirm("Deseja excluir?")) {
            db.transaction(function (tx) {
               tx.executeSql('DELETE FROM Gastos WHERE codigo=' + idGastos + ' ;', [], function (tx, rs) {

               }, function (tx, error) {
                  console.log('SELECT error: ' + error.message);
               });
            });
            preencheGastos();
         }
      }

      function deletar(idAgenda) {
         if (confirm("Deseja excluir?")) {
            db.transaction(function (tx) {
               tx.executeSql('DELETE FROM Agenda WHERE codigo=' + idAgenda + ' ;', [], function (tx, rs) {

               }, function (tx, error) {
                  console.log('SELECT error: ' + error.message);
               });
            });
            preencheAgenda();
            preencheTodos(6);
         }
      }




      var time = setInterval(function () {
         if ($("#todos").find(".preloader-wrapper").length > 0) {
            preencheTodos(6);

            myStopFunction();
         }


      }, 3000);

      function myStopFunction() {
         clearInterval(time);
      }



   </script>







</body>

</html>